<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Comida Pregoneros 2025</title>
<style>
  body {
    font-family: Arial, sans-serif;
    color: #6a0dad;
    background: #fff;
    max-width: 700px;
    margin: auto;
    padding: 1em;
  }
  h1 {
    text-align: center;
    margin-bottom: 0.5em;
  }
  label {
    font-weight: bold;
    display: block;
    margin-top: 12px;
  }
  input[type=text], input[type=number] {
    width: 100%;
    padding: 6px;
    font-size: 1em;
    margin-top: 4px;
    border-radius: 5px;
    border: 1px solid #b19cd9;
  }
  button {
    margin-top: 20px;
    padding: 10px 18px;
    font-size: 1.1em;
    background-color: #9b6dc7;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover {
    background-color: #7a54a0;
  }
  #duplicadosList {
    background: #eee;
    border: 1px solid #999;
    padding: 10px;
    margin-top: 15px;
    border-radius: 6px;
  }
  #duplicadosList ul {
    list-style: none;
    padding-left: 0;
  }
  #duplicadosList li {
    padding: 6px;
    border-bottom: 1px solid #ccc;
    cursor: pointer;
  }
  #duplicadosList li:hover {
    background-color: #d8c8f5;
  }
  #btnNuevoPedido {
    margin-top: 10px;
    background-color: #5a2a72;
  }
</style>
</head>
<body>

<h1>Comida Pregoneros 2025</h1>

<div id="duplicadosList" style="display:none;">
  <strong>Pedidos con este Nombre y Apellido encontrados. Haz clic para cargar y actualizar:</strong>
  <ul id="listaDuplicados"></ul>
  <button id="btnNuevoPedido">Crear pedido nuevo</button>
</div>

<form id="pedidoForm">
  <label for="nombre">Nombre:</label>
  <input type="text" id="nombre" required autocomplete="off" />

  <label for="apellido">Apellido:</label>
  <input type="text" id="apellido" required autocomplete="off" />

  <label for="trasera">Trasera de pollo:</label>
  <input type="number" id="trasera" min="0" value="0" />

  <label for="cajilla">Cajilla:</label>
  <input type="number" id="cajilla" min="0" value="0" />

  <label for="codillo">1/2 Codillo:</label>
  <input type="number" id="codillo" min="0" value="0" />

  <label for="paella">Paella:</label>
  <input type="number" id="paella" min="0" value="0" />

  <label for="fideua">Fideua:</label>
  <input type="number" id="fideua" min="0" value="0" />

  <label for="salchichas">Salchichas al Vino Blanco:</label>
  <input type="number" id="salchichas" min="0" value="0" />

  <label for="lomo">Lomo a la Riojana:</label>
  <input type="number" id="lomo" min="0" value="0" />

  <label for="jamoncitos">Jamoncitos de Pollo al Chilindrón:</label>
  <input type="number" id="jamoncitos" min="0" value="0" />

  <button type="submit">Guardar Pedido</button>
  <button type="button" id="descargarBtn">Descargar Pedido</button>
</form>

<script>
  const API_KEY = "patNdhdFMrPI0rEVu.3db56e0e78d6f1bee371e038634a6a909f46dfa5c860380cd7703d14651bedd5";
  const BASE_ID = "appP2Lrc5NRcaNXF6";
  const TABLE_NAME = "Comida";

  const baseUrl = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}`;

  let actualizarRecordId = null;

  // Normaliza texto: primera letra mayúscula, resto minúscula, sin espacios extras
  function normalizarTexto(text) {
    return text.trim().toLowerCase().replace(/\s+/g, ' ')
      .split(' ')
      .map(palabra => palabra.charAt(0).toUpperCase() + palabra.slice(1))
      .join(' ');
  }

  // Buscar pedidos por Nombre + Apellido
  async function buscarPedidos(nombre, apellido) {
    const formula = `AND({Nombre}="${nombre}", {Apellido}="${apellido}")`;
    const url = `${baseUrl}?filterByFormula=${encodeURIComponent(formula)}`;
    const resp = await fetch(url, {
      headers: { Authorization: `Bearer ${API_KEY}` }
    });
    if (!resp.ok) throw new Error("Error buscando pedidos");
    const data = await resp.json();
    return data.records;
  }

  // Insertar pedido nuevo
  async function insertarPedido(fields) {
    const resp = await fetch(baseUrl, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ fields })
    });
    if (!resp.ok) throw new Error("Error al guardar pedido");
    return await resp.json();
  }

  // Actualizar pedido existente
  async function actualizarPedido(recordId, fields) {
    const url = `${baseUrl}/${recordId}`;
    const resp = await fetch(url, {
      method: "PATCH",
      headers: {
        Authorization: `Bearer ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ fields })
    });
    if (!resp.ok) throw new Error("Error al actualizar pedido");
    return await resp.json();
  }

  // Cargar datos en formulario
  function cargarDatosPedido(record) {
    const f = record.fields;
    document.getElementById('nombre').value = f.Nombre || "";
    document.getElementById('apellido').value = f.Apellido || "";
    document.getElementById('trasera').value = f["Trasera de pollo"] || 0;
    document.getElementById('cajilla').value = f.Cajilla || 0;
    document.getElementById('codillo').value = f["1/2 Codillo"] || 0;
    document.getElementById('paella').value = f.Paella || 0;
    document.getElementById('fideua').value = f.Fideua || 0;
    document.getElementById('salchichas').value = f["Salchichas al Vino Blanco"] || 0;
    document.getElementById('lomo').value = f["Lomo a la Riojana"] || 0;
    document.getElementById('jamoncitos').value = f["Jamoncitos de Pollo al Chilindrón"] || 0;
  }

  // Mostrar duplicados para seleccionar
  function mostrarDuplicados(records) {
    const cont = document.getElementById('duplicadosList');
    const ul = document.getElementById('listaDuplicados');
    ul.innerHTML = "";
    records.forEach(rec => {
      const li = document.createElement('li');
      const f = rec.fields;
      li.textContent = `ID:${rec.id} - Trasera:${f["Trasera de pollo"]||0}, Cajilla:${f.Cajilla||0}, Paella:${f.Paella||0}`;
      li.onclick = () => {
        actualizarRecordId = rec.id;
        cargarDatosPedido(rec);
        cont.style.display = 'none';
        alert("Datos cargados para actualizar este pedido. Pulsa Guardar para actualizar.");
      };
      ul.appendChild(li);
    });
    cont.style.display = "block";
  }

  // Limpiar formulario y estado actualización
  function limpiarFormulario() {
    actualizarRecordId = null;
    document.getElementById('pedidoForm').reset();
    document.getElementById('duplicadosList').style.display = 'none';
  }

  // Evento submit
  document.getElementById('pedidoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      // Normalizar
      const nombre = normalizarTexto(document.getElementById('nombre').value);
      const apellido = normalizarTexto(document.getElementById('apellido').value);

      if (!nombre || !apellido) {
        alert("Nombre y Apellido son obligatorios.");
        return;
      }

      // Recoger cantidades, asegurando números (>=0)
      const camposCantidad = [
        "trasera", "cajilla", "codillo", "paella", "fideua",
        "salchichas", "lomo", "jamoncitos"
      ];
      const camposCamposAirtable = {
        trasera: "Trasera de pollo",
        cajilla: "Cajilla",
        codillo: "1/2 Codillo",
        paella: "Paella",
        fideua: "Fideua",
        salchichas: "Salchichas al Vino Blanco",
        lomo: "Lomo a la Riojana",
        jamoncitos: "Jamoncitos de Pollo al Chilindrón"
      };
      const camposData = {
        Nombre: nombre,
        Apellido: apellido
      };
      for (const c of camposCantidad) {
        let val = parseInt(document.getElementById(c).value);
        if (isNaN(val) || val < 0) val = 0;
        camposData[camposCamposAirtable[c]] = val;
      }

      // Si estamos actualizando, hacemos PATCH
      if (actualizarRecordId) {
        await actualizarPedido(actualizarRecordId, camposData);
        alert("Pedido actualizado correctamente.");
      } else {
        // Antes de insertar, buscamos duplicados para evitar duplicar sin querer
        const pedidos = await buscarPedidos(nombre, apellido);
        if (pedidos.length > 0) {
          // Mostrar para seleccionar actualizar o crear nuevo
          mostrarDuplicados(pedidos);
          alert("Ya existen pedidos con ese Nombre y Apellido. Por favor selecciona uno para actualizar o crea uno nuevo.");
          return;
        }
        // Si no hay duplicados, insertar
        await insertarPedido(camposData);
        alert("Pedido guardado correctamente.");
      }

      limpiarFormulario();
    } catch (error) {
      alert("Error: " + error.message);
    }
  });

  // Evento para buscar duplicados al cambiar nombre o apellido
  function buscarYMostrarDuplicados() {
    const nombre = normalizarTexto(document.getElementById('nombre').value);
    const apellido = normalizarTexto(document.getElementById('apellido').value);
    if (!nombre || !apellido) {
      document.getElementById('duplicadosList').style.display = 'none';
      actualizarRecordId = null;
      return;
    }
    buscarPedidos(nombre, apellido).then(records => {
      if (records.length > 0) {
        mostrarDuplicados(records);
      } else {
        document.getElementById('duplicadosList').style.display = 'none';
        actualizarRecordId = null;
      }
    }).catch(() => {
      document.getElementById('duplicadosList').style.display = 'none';
      actualizarRecordId = null;
    });
  }

  document.getElementById('nombre').addEventListener('change', buscarYMostrarDuplicados);
  document.getElementById('apellido').addEventListener('change', buscarYMostrarDuplicados);

  // Botón para crear pedido nuevo (ignorar selección)
  document.getElementById('btnNuevoPedido').onclick = () => {
    actualizarRecordId = null;
    limpiarFormulario();
  };

  // Botón descargar pedido actual en txt
  document.getElementById('descargarBtn').addEventListener('click', () => {
    const nombre = document.getElementById('nombre').value.trim();
    const apellido = document.getElementById('apellido').value.trim();
    if (!nombre || !apellido) {
      alert("Debes ingresar Nombre y Apellido para descargar.");
      return;
    }
    let texto = `Pedido para ${nombre} ${apellido}:\n\n`;
    const campos = [
      { id: "trasera", label: "Trasera de pollo" },
      { id: "cajilla", label: "Cajilla" },
      { id: "codillo", label: "1/2 Codillo" },
      { id: "paella", label: "Paella" },
      { id: "fideua", label: "Fideua" },
      { id: "salchichas", label: "Salchichas al Vino Blanco" },
      { id: "lomo", label: "Lomo a la Riojana" },
      { id: "jamoncitos", label: "Jamoncitos de Pollo al Chilindrón" }
    ];
    campos.forEach(c => {
      const val = document.getElementById(c.id).value;
      texto += `${c.label}: ${val}\n`;
    });

    const blob = new Blob([texto], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pedido_${normalizarTexto(nombre)}_${normalizarTexto(apellido)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
</script>

</body>
</html>
