<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comida Pregoneros 2025</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; color: #333; }
    form { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; }
    input[type="text"], input[type="number"] { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 15px; background: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
</style>
</head>
<body>

<h1>Comida Pregoneros 2025</h1>

<form id="formularioPedidos">
    <label>Nombre
        <input type="text" id="nombre" required>
    </label>
    <label>Apellido
        <input type="text" id="apellido" required>
    </label>

    <h3>Primeros Platos</h3>
    <label>Ensalada
        <input type="number" id="ensalada" min="0" value="0">
    </label>
    <label>Sopa
        <input type="number" id="sopa" min="0" value="0">
    </label>

    <h3>Segundos Platos</h3>
    <label>Pollo
        <input type="number" id="pollo" min="0" value="0">
    </label>
    <label>Pescado
        <input type="number" id="pescado" min="0" value="0">
    </label>

    <h3>Postres</h3>
    <label>Fruta
        <input type="number" id="fruta" min="0" value="0">
    </label>
    <label>Helado
        <input type="number" id="helado" min="0" value="0">
    </label>

    <button type="button" onclick="guardarPedido()">Guardar Pedido</button>
    <button type="button" onclick="exportExcel()">Exportar Excel</button>
    <button type="button" onclick="exportPDF()">Exportar PDF</button>
</form>

<script>
const AIRTABLE_API_KEY = "TU_API_KEY";
const AIRTABLE_BASE_ID = "TU_BASE_ID";
const AIRTABLE_TABLE_NAME = "Pedidos";

const categorias = {
    "Primeros Platos": ["ensalada","sopa"],
    "Segundos Platos": ["pollo","pescado"],
    "Postres": ["fruta","helado"]
};

function normalizar(str) {
    return str.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function obtenerDatos() {
    const nombre = document.getElementById("nombre").value;
    const apellido = document.getElementById("apellido").value;

    let datos = {
        "Nombre": nombre,
        "Apellido": apellido,
        "Nombre_norm": normalizar(nombre),
        "Apellido_norm": normalizar(apellido)
    };

    Object.values(categorias).flat().forEach(id => {
        datos[id] = parseInt(document.getElementById(id).value) || 0;
    });

    return datos;
}

async function guardarPedido() {
    const datos = obtenerDatos();

    const query = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?filterByFormula=AND({Nombre_norm}='${datos.Nombre_norm}',{Apellido_norm}='${datos.Apellido_norm}')`;
    const res = await fetch(query, {
        headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` }
    });
    const json = await res.json();

    if(json.records.length > 0) {
        if(confirm('El pedido ya existe. ¿Desea actualizarlo?')) {
            const recordId = json.records[0].id;
            await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}/${recordId}`, {
                method: 'PATCH',
                headers: {
                    Authorization: `Bearer ${AIRTABLE_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fields: datos })
            });
            alert('Pedido actualizado correctamente');
        } else {
            alert('No se ha guardado el pedido');
        }
    } else {
        await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`, {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${AIRTABLE_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ fields: datos })
        });
        alert('Pedido guardado correctamente');
    }
}

async function exportExcel() {
    const res = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`, {
        headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` }
    });
    const json = await res.json();

    let csvContent = "data:text/csv;charset=utf-8,";
    const headers = ["Nombre","Apellido"].concat(Object.values(categorias).flat());
    csvContent += headers.join(",") + "\r\n";

    json.records.forEach(record => {
        const row = headers.map(h => record.fields[h] || "");
        csvContent += row.join(",") + "\r\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "Pedidos_Comida_Pregoneros_2025.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');
    const res = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`, {
        headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` }
    });
    const json = await res.json();

    const img = new Image();
    img.src = 'logo.png'; // Asegúrate de tener tu logo en la misma carpeta
    img.onload = () => {
        doc.addImage(img, 'PNG', 40, 20, 100, 50);
        doc.setFontSize(18);
        doc.text("Comida Pregoneros 2025", 200, 50);

        let y = 90;
        Object.keys(categorias).forEach(cat => {
            doc.setFontSize(14);
            doc.text(cat, 40, y);
            y += 20;
            json.records.forEach(r => {
                let line = `${r.fields.Nombre || ''} ${r.fields.Apellido || ''}: `;
                categorias[cat].forEach(p => {
                    if(r.fields[p] && r.fields[p] > 0) line += `${p} (${r.fields[p]}), `;
                });
                if(line.endsWith(", ")) line = line.slice(0, -2);
                if(line.trim() !== `${r.fields.Nombre || ''} ${r.fields.Apellido || ''}:`) {
                    doc.setFontSize(12);
                    doc.text(line, 50, y);
                    y += 15;
                    if(y > 770) { doc.addPage(); y = 40; }
                }
            });
            y += 15;
        });

        doc.save("Pedidos_Comida_Pregoneros_2025.pdf");
    }
}
</script>

</body>
</html>





