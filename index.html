<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Comida Pregoneros 2025</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f9f7fc;
    color: #4a148c;
  }
  body {
    background: url('assets/20250608_111348_206.png') no-repeat center top;
    background-size: 150px auto;
    background-attachment: scroll;
  }
  header {
    padding: 30px 20px 10px 20px;
    text-align: center;
    background: transparent;
    position: relative;
  }
  .titulo-bg {
    display: inline-block;
    background: rgba(255, 255, 255, 0.85);
    padding: 10px 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(106, 13, 173, 0.25);
  }
  header h1 {
    font-size: 2.8em;
    margin: 0;
    font-weight: 700;
    color: #6a0dad;
    text-shadow: 1px 1px 5px rgba(0,0,0,0.15);
  }

  form {
    max-width: 620px;
    background: rgba(255, 255, 255, 0.95);
    margin: 40px auto 60px auto;
    padding: 30px 30px 40px 30px;
    border-radius: 14px;
    box-shadow: 0 8px 25px rgba(106, 13, 173, 0.2);
    color: #5a2a72;
  }
  form label {
    font-weight: 600;
    display: block;
    margin-top: 20px;
    color: #4a148c;
    text-shadow: 0 0 3px rgba(255 255 255 / 0.8);
  }
  input[type="text"], input[type="number"] {
    width: 100%;
    padding: 10px 12px;
    margin-top: 8px;
    box-sizing: border-box;
    border: 2px solid #b19cd9;
    border-radius: 8px;
    font-size: 1em;
    background: #f8f5fc;
    color: #4b1d75;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }
  input[type="text"]:focus, input[type="number"]:focus {
    border-color: #6a0dad;
    outline: none;
    box-shadow: 0 0 8px #6a0dadaa;
  }
  button {
    background-color: #9b6dc7;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.2em;
    padding: 14px 22px;
    transition: background-color 0.3s ease;
    box-shadow: 0 4px 15px rgba(155, 109, 199, 0.5);
  }
  button:hover {
    background-color: #7a54a0;
  }
  .botones {
    display: flex;
    gap: 18px;
    margin-top: 36px;
    justify-content: center;
  }
  @media (max-width: 480px) {
    header h1 {
      font-size: 2.2em;
      padding: 0 10px;
    }
    form {
      margin: 20px 15px 70px 15px;
      padding: 25px 20px 30px 20px;
      max-width: 95%;
    }
    .botones {
      flex-direction: column;
      gap: 12px;
    }
  }
</style>
</head>
<body>
  <header>
    <div class="titulo-bg">
      <h1>Comida Pregoneros 2025</h1>
    </div>
  </header>

  <form id="pedidoForm">
    <label for="nombre">Nombre:</label>
    <input type="text" id="nombre" required autocomplete="off" />
    <label for="apellido">Apellido:</label>
    <input type="text" id="apellido" required autocomplete="off" />
    <label for="trasera">Trasera de pollo:</label>
    <input type="number" id="trasera" min="0" value="0" />
    <label for="cajilla">Cajilla:</label>
    <input type="number" id="cajilla" min="0" value="0" />
    <label for="codillo">1/2 Codillo:</label>
    <input type="number" id="codillo" min="0" value="0" />
    <label for="paella">Paella:</label>
    <input type="number" id="paella" min="0" value="0" />
    <label for="fideua">Fideua:</label>
    <input type="number" id="fideua" min="0" value="0" />
    <label for="salchichas">Salchichas al Vino Blanco:</label>
    <input type="number" id="salchichas" min="0" value="0" />
    <label for="lomo">Lomo a la Riojana:</label>
    <input type="number" id="lomo" min="0" value="0" />
    <label for="jamoncitos">Jamoncitos de Pollo al Chilindrón:</label>
    <input type="number" id="jamoncitos" min="0" value="0" />
    <div class="botones">
      <button type="submit">Guardar Pedido</button>
      <button type="button" id="descargarBtn">Descargar Pedido</button>
    </div>
  </form>

  <script>
    const API_KEY = "patNdhdFMrPI0rEVu.3db56e0e78d6f1bee371e038634a6a909f46dfa5c860380cd7703d14651bedd5";
    const BASE_ID = "appP2Lrc5NRcaNXF6";
    const TABLE_NAME = "Comida";

    // Función para normalizar strings: minúsculas y sin espacios extras
    function normalize(str) {
      return str.trim().toLowerCase();
    }

    // Busca duplicados en Airtable según nombre y apellido normalizados
    async function checkDuplicate(nombreNorm, apellidoNorm) {
      const filterFormula = `AND({Nombre_norm} = "${nombreNorm}", {Apellido_norm} = "${apellidoNorm}")`;
      const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}?filterByFormula=${encodeURIComponent(filterFormula)}`;

      try {
        const res = await fetch(url, {
          headers: {
            Authorization: `Bearer ${API_KEY}`
          }
        });
        const data = await res.json();
        return data.records || [];
      } catch (err) {
        console.error("Error al consultar duplicados:", err);
        return [];
      }
    }

    document.getElementById('pedidoForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const nombreRaw = document.getElementById('nombre').value;
      const apellidoRaw = document.getElementById('apellido').value;

      const nombre = normalize(nombreRaw);
      const apellido = normalize(apellidoRaw);

      // Busca duplicados
      const existing = await checkDuplicate(nombre, apellido);

      // Prepara datos para crear/actualizar registro
      const data = {
        fields: {
          "Nombre": nombreRaw,
          "Apellido": apellidoRaw,
          "Nombre_norm": nombre,
          "Apellido_norm": apellido,
          "Trasera de pollo": parseInt(document.getElementById('trasera').value) || 0,
          "Cajilla": parseInt(document.getElementById('cajilla').value) || 0,
          "1/2 Codillo": parseInt(document.getElementById('codillo').value) || 0,
          "Paella": parseInt(document.getElementById('paella').value) || 0,
          "Fideua": parseInt(document.getElementById('fideua').value) || 0,
          "Salchichas al Vino Blanco": parseInt(document.getElementById('salchichas').value) || 0,
          "Lomo a la Riojana": parseInt(document.getElementById('lomo').value) || 0,
          "Jamoncitos de Pollo al Chilindrón": parseInt(document.getElementById('jamoncitos').value) || 0
        }
      };

      try {
        let response;

        if (existing.length > 0) {
          const idRegistro = existing[0].id;
          const actualizar = confirm(`Ya existe un pedido para "${nombreRaw} ${apellidoRaw}". ¿Quieres actualizarlo con los nuevos datos?`);
          if (!actualizar) return;

          // PATCH para actualizar registro
          response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${idRegistro}`, {
            method: "PATCH",
            headers: {
              "Authorization": `Bearer ${API_KEY}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
          });

        } else {
          // POST para crear nuevo registro
          response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${API_KEY}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
          });
        }

        if (response.ok) {
          alert("Pedido guardado correctamente ✅");
          document.getElementById('pedidoForm').reset();
        } else {
          const err = await response.json();
          console.error(err);
          alert("Error al guardar en Airtable ❌");
        }

      } catch (error) {
        console.error(error);
        alert("Error de conexión ❌");
      }
    });

    // Funcionalidad descarga CSV completa de la tabla
    document.getElementById('descargarBtn').addEventListener('click', async () => {
      const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}?pageSize=100`;
      try {
        const res = await fetch(url, {
          headers: { Authorization: `Bearer ${API_KEY}` }
        });
        if (!res.ok) throw new Error("No se pudo descargar datos");

        const data = await res.json();
        const records = data.records;

        if (records.length === 0) {
          alert("No hay pedidos para descargar.");
          return;
        }

        // Prepara CSV
        const headers = ["Nombre", "Apellido", "Trasera de pollo", "Cajilla", "1/2 Codillo", "Paella", "Fideua", "Salchichas al Vino Blanco", "Lomo a la Riojana", "Jamoncitos de Pollo al Chilindrón"];
        const rows = records.map(r => {
          const f = r.fields;
          return headers.map(h => (f[h] !== undefined ? f[h] : "")).join(",");
        });
        const csvContent = [headers.join(","), ...rows].join("\n");

        // Descargar CSV
        const blob = new Blob([csvContent], {type: "text/csv;charset=utf-8;"});
        const urlBlob = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = urlBlob;
        link.download = "pedidos_comida_pregoneros_2025.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

      } catch (error) {
        console.error(error);
        alert("Error al descargar datos ❌");
      }
    });
  </script>
</body>
</html>
